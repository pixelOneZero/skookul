site.transportation={map:"",markersArray:[],routesArray:[],infoWindowsArray:[],intGetLocations:"",dt:new Date,strLoading:"<img src='/images/icon-loading.gif' id='icon-loading-data' style='display:none;position:absolute;top:0;left:270px;z-index:2;' />",kmlTrain:"http://skookul.com/transportation/kml/regionalrail.kml",transitType:"bus",setTransitType:function(a){var b=site.transportation.dt.getTime();site.transportation.transitType=a;site.transportation.clearOverlays();site.transportation.clearRoute();
clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);"train"==a&&(site.transportation.kmlTrain=site.transportation.kmlTrain+"?dst="+b,a=new google.maps.KmlLayer(site.transportation.kmlTrain),a.setMap(map),site.transportation.routesArray.push(a))},loadMap:function(){var a={center:new google.maps.LatLng(39.952335,-75.163789),zoom:11,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),a)},setMarkers:function(a,b,e,d,c){a=new google.maps.LatLng(a,
b);a=new google.maps.Marker({position:a,animation:google.maps.Animation.DROP,map:map});site.transportation.setInfoWindows(a,e,d,c);site.transportation.markersArray.push(a)},clearOverlays:function(){if(site.transportation.markersArray)for(i in site.transportation.markersArray)site.transportation.markersArray[i].setMap(null)},clearRoute:function(){if(site.transportation.routesArray)for(i in site.transportation.routesArray)site.transportation.routesArray[i].setMap(null)},clearInfoWindows:function(){if(site.transportation.infoWindowsArray)for(i in site.transportation.infoWindowsArray)site.transportation.infoWindowsArray[i].close()},
getLocations:function(a){site.transportation.clearOverlays();var b=(new Date).getTime();if("bus"==site.transportation.transitType||"trolley"==site.transportation.transitType)$.getJSON("http://www3.septa.org/hackathon/TransitView/?route="+a+"&dm="+b+"&callback=?",function(a){$("#icon-loading-data").hide();$.each(a.bus,function(c,b){site.transportation.setMarkers(b.lat,b.lng,b.Direction,b.destination,b);if(c==a.bus.length-1){var e=new google.maps.LatLng(b.lat,b.lng);map.panTo(e)}})});else{var e;$.getJSON("http://www3.septa.org/hackathon/TrainView/?dm="+
b+"&callback=?",function(b){$("#icon-loading-data").hide();$.each(b,function(c){e=b[c].dest.toLowerCase();e=e.replace(/\s/g,"-");e==a&&"NO PSGRS"!=b[c].service&&(site.transportation.setMarkers(b[c].lat,b[c].lon,b[c].nextstop,b[c].dest,b[c]),c=new google.maps.LatLng(b[c].lat,b[c].lon),map.panTo(c))})})}},setRoute:function(a){var b=site.transportation.dt.getTime(),a="bus"==site.transportation.transitType||"trolley"==site.transportation.transitType?new google.maps.KmlLayer("http://www3.septa.org/transitview/kml/"+
a+".kml?dts="+b):new google.maps.KmlLayer("http://skookul.com/transportation/kml/regionalrail.kml?dts="+b);"undefined"!=typeof a&&(a.setMap(map),site.transportation.routesArray.push(a))},toggleGrid:function(){"train"==site.transportation.transitType?($(".grid .bus").fadeOut(),$(".grid .trolley").fadeOut(),$(".grid .train").fadeIn()):"trolley"==site.transportation.transitType?($(".grid .train").fadeOut(),$(".grid .bus").fadeOut(),$(".grid .trolley").fadeIn()):($(".grid .train").fadeOut(),$(".grid .trolley").fadeOut(),
$(".grid .bus").fadeIn());$("."+site.transportation.transitType+" div.grid-cell").each(function(){"grid-cell active"==$(this).attr("class")&&$(this).trigger("click")})},setLinks:function(){$("a[rel=train]").click(function(){site.transportation.setTransitType("train");site.transportation.setAppState("train","1");site.transportation.toggleGrid();$(".left-col > p > a").removeClass("active");$(this).addClass("active")});$("a[rel=bus]").click(function(){site.transportation.setTransitType("bus");site.transportation.setAppState("bus",
"1");site.transportation.toggleGrid();$(".left-col > p > a").removeClass("active");$(this).addClass("active")});$("a[rel=trolley]").click(function(){site.transportation.setTransitType("trolley");site.transportation.setAppState("trolley","1");site.transportation.toggleGrid();$(".left-col > p > a").removeClass("active");$(this).addClass("active")});$(".bus .grid-cell").click(function(){site.transportation.transitType="bus";$("#icon-loading-data").show();clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);
var a=$(this).attr("rel");site.transportation.setAppState("-"+a,"0");site.transportation.clearOverlays();site.transportation.clearRoute();site.transportation.setRoute(a);site.transportation.getLocations(a,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations("+a+", '0')",6E4);$(".bus .grid-cell").removeClass("active");$(this).addClass("active")});$(".train .grid-cell").click(function(){site.transportation.transitType="train";$("#icon-loading-data").show();clrIntGetLocations=
window.clearInterval(site.transportation.intGetLocations);var a=$(this).attr("rel");site.transportation.setAppState("-"+a,"0");site.transportation.clearOverlays();site.transportation.clearRoute();site.transportation.setRoute(a);site.transportation.getLocations(a,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations('"+a+"', '0')",6E4);$(".train .grid-cell").removeClass("active");$(this).addClass("active")});$(".trolley .grid-cell").click(function(){site.transportation.transitType=
"trolley";$("#icon-loading-data").show();clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);var a=$(this).attr("rel");site.transportation.setAppState("-"+a,"0");site.transportation.clearOverlays();site.transportation.clearRoute();site.transportation.setRoute(a);site.transportation.getLocations(a,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations('"+a+"', '0')",6E4);$(".trolley .grid-cell").removeClass("active");$(this).addClass("active")})},
setInfoWindows:function(a,b,e,d){var c;if("train"==site.transportation.transitType)c=2>Math.abs(d.late)?" minute":" minutes",c=0>d.late?Math.abs(d.late)+c+" ahead of schedule.":0==d.late?"Running on time.":d.late+c+" behind schedule.",c="<dl><dt>"+site.transportation.transitType+" number: </dt><dd>"+d.trainno+"</dd><dt>Next stop: </dt><dd>"+b+"</dd><dt>Destination:</dt><dd>"+e+"</dd></dl>"+c;else if("bus"==site.transportation.transitType||"trolley"==site.transportation.transitType){c=1>Math.abs(d.Offset)?
" < 1 ":d.Offset;var g=2>Math.abs(d.Offset)?" minute ":" minutes ";c="<dl><dt>"+site.transportation.transitType+" Number:</dt><dd>"+d.VehicleID+"</dd><dt>Headed: </dt><dd>"+b+"</dd><dt>Toward:</dt><dd>"+e+"</dd></dl> Last updated "+c+g+" ago."}""==b.replace(/\s/g,"")&&""==e.replace(/\s/g,"")&&(c="<dl><dt>"+site.transportation.transitType+" Number:</dt><dd>"+d.VehicleID+"</dd></dl><p><strong>Note:</strong> This "+site.transportation.transitType+" is not currently moving.</p>");var f=new google.maps.InfoWindow({content:c});
site.transportation.infoWindowsArray.push(f);google.maps.event.addListener(a,"click",function(){site.transportation.clearInfoWindows();f.open(map,a)})},setAppState:function(a,b){"1"==b?(window.location.hash="",window.location.hash=a):(-1<window.location.hash.indexOf("-")&&(window.location.hash=window.location.hash.substring(0,window.location.hash.indexOf("-"))),window.location.hash+=a)},getAppState:function(){var a,b;""!=window.location.hash?(-1<window.location.hash.indexOf("-")?(a=window.location.hash.substring(1,
window.location.hash.indexOf("-")),b=window.location.hash.substring(window.location.hash.indexOf("-")+1,window.location.hash.length)):a=window.location.hash.substring(1,window.location.hash.length),$("a[rel="+a+"]").trigger("click"),$("div[rel="+b+"]").trigger("click")):(window.location.hash="#bus",$("a[rel=bus]").addClass("active"))}};$(document).ready(function(){$(".left-col h2").append(site.transportation.strLoading);site.transportation.loadMap();site.transportation.setLinks();site.transportation.getAppState()});