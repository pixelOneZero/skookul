site.transportation={map:"",mobile:!1,markersArray:[],routesArray:[],infoWindowsArray:[],selectedRouteNumber:"",intGetLocations:"",dt:new Date,strLoading:"<img src='../images/icon-loading.gif' id='icon-loading-data' />",kmlTrain:"http://skookul.com/transportation/kml/regionalrail.kml",transitType:"bus",self:this,setTransitType:function(b){var a=site.transportation.dt.getTime();site.transportation.transitType=b;site.transportation.clearOverlays();site.transportation.clearRoute();clrIntGetLocations=
window.clearInterval(site.transportation.intGetLocations);"train"==b&&(site.transportation.kmlTrain=site.transportation.kmlTrain+"?dst="+a,b=new google.maps.KmlLayer(site.transportation.kmlTrain),b.setMap(map),site.transportation.routesArray.push(b))},loadMap:function(){var b={center:new google.maps.LatLng(39.952335,-75.163789),zoom:12,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map(document.getElementById("map_canvas"),b)},setMarkers:function(b,a,d,e,c){b=new google.maps.LatLng(b,
a);b=new google.maps.Marker({position:b,animation:google.maps.Animation.DROP,icon:"../images/marker-"+site.transportation.transitType+".png",map:map});site.transportation.setInfoWindows(b,d,e,c);site.transportation.markersArray.push(b)},clearOverlays:function(){if(site.transportation.markersArray)for(i in site.transportation.markersArray)site.transportation.markersArray[i].setMap(null)},clearRoute:function(){if(site.transportation.routesArray)for(i in site.transportation.routesArray)site.transportation.routesArray[i].setMap(null)},
clearInfoWindows:function(){if(site.transportation.infoWindowsArray)for(i in site.transportation.infoWindowsArray)site.transportation.infoWindowsArray[i].close()},getLocations:function(b){site.transportation.clearOverlays();var a=(new Date).getTime();if("bus"==site.transportation.transitType||"trolley"==site.transportation.transitType)$.getJSON("http://www3.septa.org/hackathon/TransitView/?route="+b+"&dm="+a+"&callback=?",function(b){$("#icon-loading-data").hide();$.each(b.bus,function(c,a){site.transportation.setMarkers(a.lat,
a.lng,a.Direction,a.destination,a);if(c==b.bus.length-1){var d=new google.maps.LatLng(a.lat,a.lng);map.panTo(d)}})});else{var d;$.getJSON("http://www3.septa.org/hackathon/TrainView/?dm="+a+"&callback=?",function(a){$("#icon-loading-data").hide();$.each(a,function(c){d=a[c].dest.toLowerCase();d=d.replace(/\s/g,"-");d==b&&"NO PSGRS"!=a[c].service&&(site.transportation.setMarkers(a[c].lat,a[c].lon,a[c].nextstop,a[c].dest,a[c]),c=new google.maps.LatLng(a[c].lat,a[c].lon),map.panTo(c))})})}},setRoute:function(b){var a=
site.transportation.dt.getTime();b="bus"==site.transportation.transitType||"trolley"==site.transportation.transitType?new google.maps.KmlLayer("http://www3.septa.org/transitview/kml/"+b+".kml?dts="+a):new google.maps.KmlLayer("http://skookul.com/transportation/kml/"+site.transportation.selectedRouteNumber+".kml?dts="+a);"undefined"!=typeof b&&(b.setMap(map),site.transportation.routesArray.push(b))},toggleGrid:function(){"train"==site.transportation.transitType?($(".grid .bus").hide(),$(".grid .trolley").hide(),
$(".grid .train").show()):"trolley"==site.transportation.transitType?($(".grid .train").hide(),$(".grid .bus").hide(),$(".grid .trolley").show()):($(".grid .train").hide(),$(".grid .trolley").hide(),$(".grid .bus").show());$("."+site.transportation.transitType+" div.grid-cell").each(function(){"grid-cell active"==$(this).attr("class")&&$(this).trigger("click")});site.transportation.mobile&&$(".grid").show()},setLinks:function(){$("nav > a").click(function(){$(".left-col > nav > a").removeClass("active")});
$(".grid-cell").click(function(){$(".grid-cell").removeClass("active")});$("a[rel=train]").click(function(){site.transportation.setTransitType("train");site.transportation.setAppState("train","1");site.transportation.toggleGrid();$(this).addClass("active")});$("a[rel=bus]").click(function(){site.transportation.setTransitType("bus");site.transportation.setAppState("bus","1");site.transportation.toggleGrid();$(this).addClass("active")});$("a[rel=trolley]").click(function(){site.transportation.setTransitType("trolley");
site.transportation.setAppState("trolley","1");site.transportation.toggleGrid();$(this).addClass("active")});$(".bus .grid-cell").click(function(){site.transportation.transitType="bus";$("#icon-loading-data").show();clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);site.transportation.selectedRouteNumber=$(this).attr("rel");site.transportation.setAppState("-"+site.transportation.selectedRouteNumber,"0");site.transportation.clearOverlays();site.transportation.clearRoute();
site.transportation.setRoute(site.transportation.selectedRouteNumber);site.transportation.getLocations(site.transportation.selectedRouteNumber,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations("+site.transportation.selectedRouteNumber+", '0')",6E4);$(this).addClass("active")});$(".train .grid-cell").click(function(){site.transportation.transitType="train";$("#icon-loading-data").show();clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);
site.transportation.selectedRouteNumber=$(this).attr("rel");site.transportation.setAppState("-"+site.transportation.selectedRouteNumber,"0");site.transportation.clearOverlays();site.transportation.clearRoute();site.transportation.setRoute(site.transportation.selectedRouteNumber);site.transportation.getLocations(site.transportation.selectedRouteNumber,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations('"+site.transportation.selectedRouteNumber+"', '0')",6E4);
$(this).addClass("active")});$(".trolley .grid-cell").click(function(){site.transportation.transitType="trolley";$("#icon-loading-data").show();clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations);site.transportation.selectedRouteNumber=$(this).attr("rel");site.transportation.setAppState("-"+site.transportation.selectedRouteNumber,"0");site.transportation.clearOverlays();site.transportation.clearRoute();site.transportation.setRoute(site.transportation.selectedRouteNumber);
site.transportation.getLocations(site.transportation.selectedRouteNumber,"0");site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations('"+site.transportation.selectedRouteNumber+"', '0')",6E4);$(this).addClass("active")});$(".grid-cell").click(function(){site.transportation.mobile&&$(".grid").hide()});$(".locateUser").click(function(){site.transportation.getUserLocation(!0)})},setInfoWindows:function(b,a,d,e){var c;if("train"==site.transportation.transitType)c=2>Math.abs(e.late)?
" minute":" minutes",c=0>e.late?Math.abs(e.late)+c+" ahead of schedule.":0==e.late?"Running on time.":e.late+c+" behind schedule.",c="<dl><dt>"+site.transportation.transitType+" number: </dt><dd>"+e.trainno+"</dd><dt>Next stop: </dt><dd>"+a+"</dd><dt>Destination:</dt><dd>"+d+"</dd></dl><p>"+c+"</p>";else if("bus"==site.transportation.transitType||"trolley"==site.transportation.transitType){c=1>Math.abs(e.Offset)?" < 1 ":e.Offset;var g=2>Math.abs(e.Offset)?" minute ":" minutes ";c="<dl><dt>Route:</dt><dd>"+
site.transportation.selectedRouteNumber+"</dd><dt>"+site.transportation.transitType+" Number:</dt><dd>"+e.VehicleID+"</dd><dt>Headed: </dt><dd>"+a+"</dd></dl><p>Last updated "+c+g+" ago.</p>"}""==a.replace(/\s/g,"")&&""==d.replace(/\s/g,"")&&(c="<dl><dt>"+site.transportation.transitType+" Number:</dt><dd>"+e.VehicleID+"</dd></dl><p><strong>Note:</strong>This "+site.transportation.transitType+" is not currently moving.</p>");var f=new google.maps.InfoWindow({content:c});site.transportation.infoWindowsArray.push(f);
google.maps.event.addListener(b,"click",function(){site.transportation.clearInfoWindows();f.open(map,b)})},setAppState:function(b,a){"1"==a?(window.location.hash="",window.location.hash=b):(-1<window.location.hash.indexOf("-")&&(window.location.hash=window.location.hash.substring(0,window.location.hash.indexOf("-"))),window.location.hash+=b)},getAppState:function(){var b,a;""!=window.location.hash?(-1<window.location.hash.indexOf("-")?(b=window.location.hash.substring(1,window.location.hash.indexOf("-")),
a=window.location.hash.substring(window.location.hash.indexOf("-")+1,window.location.hash.length),site.transportation.mobile&&$(".grid").hide()):(b=window.location.hash.substring(1,window.location.hash.length),$("a[rel="+b+"]").addClass("active")),"undefined"!=typeof a&&(window.location="http://skookul.com"+window.location.pathname+"#"+b+"-"+a,site.transportation.transitType=b,clrIntGetLocations=window.clearInterval(site.transportation.intGetLocations),site.transportation.selectedRouteNumber=a,site.transportation.setAppState("-"+
site.transportation.selectedRouteNumber,a),site.transportation.clearOverlays(),site.transportation.clearRoute(),site.transportation.setRoute(site.transportation.selectedRouteNumber),site.transportation.getLocations(site.transportation.selectedRouteNumber,"0"),site.transportation.intGetLocations=self.setInterval("site.transportation.getLocations("+site.transportation.selectedRouteNumber+", '0')",6E4),$("a[rel="+b+"]").addClass("active"),$("div[rel="+a+"]").addClass("active"))):(window.location.hash=
"#bus",$("a[rel=bus]").addClass("active"))},getUserLocation:function(b){new google.maps.InfoWindow;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var d=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);geocoder=new google.maps.Geocoder;geocoder.geocode({latLng:d},function(a,c){c==google.maps.GeocoderStatus.OK?a[0]&&(marker=new google.maps.Marker({position:d,map:map,icon:"../images/icon-current-location.png"}),b&&(map.setZoom(12),map.setCenter(d))):alert("Geocoder failed due to: "+
c)})}):alert("Sorry, geolocation services are not supported by your browser.")}};$(document).ready(function(){600>window.outerWidth&&(site.transportation.mobile=!0);site.transportation.mobile?$(".left-col > nav").append(site.transportation.strLoading):$(".left-col h2").append(site.transportation.strLoading);site.transportation.loadMap();site.transportation.setLinks();site.transportation.getAppState();$("#icon-loading-data").hide()});