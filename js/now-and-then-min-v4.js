site.nowThen={map:"",markersArray:[],neighborhoodArray:[],infoWindowsArray:[],strLoading:"<img src='/images/icon-loading.gif' id='icon-loading-data' style='display:none;position:absolute;top:25px;left:25px;z-index:2;' /> <div>Loading...</div>",kmlCityLimits:"http://skookul.com/neighborhoods/city-limits.kml?uid=3",cityLimitsLayer:"",historicalSearchTerm:"",mapSharedImage:!1,latSharedImage:"",lngSharedImage:"",phId:"",loadMap:function(){var a={center:new google.maps.LatLng(39.952335,-75.163789),zoom:17,
mapTypeId:google.maps.MapTypeId.ROADMAP};site.nowThen.map=new google.maps.Map(document.getElementById("map_canvas"),a)},setKml:function(){site.nowThen.cityLimitsLayer=new google.maps.KmlLayer(site.nowThen.kmlCityLimits,{map:site.nowThen.map,preserveViewport:!0});site.nowThen.cityLimitsLayer.setMap(site.nowThen.map);site.nowThen.neighborhoodArray.push(site.nowThen.cityLimitsLayer)},loadMapSharedImage:function(){var a=window.location.search,c=",",d=a.indexOf("ll=")+3;if(0>a.indexOf(","))var c="%2C",
b=3;else b=1;site.nowThen.latSharedImage=a.substring(d,a.indexOf(c));site.nowThen.lngSharedImage=a.substring(a.indexOf(c)+b,a.indexOf("&"));a={center:new google.maps.LatLng(site.nowThen.latSharedImage,site.nowThen.lngSharedImage),zoom:17,mapTypeId:google.maps.MapTypeId.ROADMAP};site.nowThen.map=new google.maps.Map(document.getElementById("map_canvas"),a)},getThenImages:function(){var a=$("#response-frame").contents().text(),a=a.substring(a.indexOf("{"),a.lastIndexOf("}")+1),c=$.parseJSON(a);"undefined"!=
typeof c&&null!=c&&(!1==site.nowThen.mapSharedImage?(assetId=locDate=locAddess=locName=imageUrl="",$.each(c.images,function(a,b){imageUrl=b.url;imageId=imageUrl.substring(imageUrl.indexOf("=")+1,imageUrl.length);assetId=b.assetId;imageId=parseInt(imageId);imageId+=1;locName=b.name;locAddress=b.address;locDate=b.date;utm=b.loc.split("?");var e=new Proj4js.Proj("EPSG:900913"),f=new Proj4js.Proj("WGS84"),h=new Proj4js.Point(utm[1],utm[0]),g=new Proj4js.Point(utm[0],utm[1]);Proj4js.transform(e,f,h);Proj4js.transform(e,
f,g);e=new google.maps.LatLng(g.y,g.x);e=new google.maps.Marker({position:e,animation:google.maps.Animation.DROP,map:site.nowThen.map});site.nowThen.setInfoWindows(e,c,imageUrl,locName,locAddress,locDate,g.y,g.x,assetId);site.nowThen.markersArray.push(e)})):$.each(c.assets,function(a,b){imageUrl="http://phillyhistory.org/PhotoArchive/MediaStream.ashx?mediaId="+b.assetId;imageId=b.medialist[a].mediaId;locName=b.title;locAddress=b.address;locDate=b.date;assetId=b.assetId;var e=new google.maps.LatLng(site.nowThen.latSharedImage,
site.nowThen.lngSharedImage),e=new google.maps.Marker({position:e,animation:google.maps.Animation.DROP,map:site.nowThen.map});site.nowThen.setInfoWindows(e,c,imageUrl,locName,locAddress,locDate,site.nowThen.latSharedImage,site.nowThen.lngSharedImage,assetId);site.nowThen.markersArray.push(e);google.maps.event.trigger(e,"click")}),$("#icon-loading-data").hide(),$("#loader").hide())},getNowImages:function(){var a=$("#new-response-frame").contents().text(),a=a.substring(a.indexOf("{"),a.lastIndexOf("}")+
1),a=$.parseJSON(a);"undefined"!=typeof a&&null!=a&&$.each(a.photos.photo,function(a,d){imgTag="<div style='width:110px;padding:5px;border:1px solid #aaa;height:125px;font-size:10px;float:left'><img src='http://farm"+d.farm+".static.flickr.com/"+d.server+"/"+d.id+"_"+d.secret+"_s.jpg' /></div>";var b=new google.maps.LatLng(d.lat,d.lon);new google.maps.Marker({position:b,animation:google.maps.Animation.DROP,map:site.nowThen.map})})},getNowImagesLocations:function(){var a=site.nowThen.map.getBounds(),
c=a.getNorthEast().lat(),d=a.getNorthEast().lng(),b=a.getSouthWest().lat(),a=a.getSouthWest().lng();$.getJSON("http://www.panoramio.com/map/get_panoramas.php?set=public&from=0&to=40&minx="+a+"&miny="+b+"&maxx="+d+"&maxy="+c+"&size=medium&mapfilter=true&callback=?",function(){})},toggleNeighborhoodKml:function(){if(0==site.nowThen.neighborhoodArray.length)site.nowThen.setKml();else{if(site.nowThen.neighborhoodArray)for(i in site.nowThen.neighborhoodArray)site.nowThen.neighborhoodArray[i].setMap(null);
site.nowThen.neighborhoodArray.length=0}},resetMarkers:function(){$("#loader").show();$("#icon-loading-data").show();new google.maps.InfoWindow;var a=site.nowThen.map.getCenter(),a=new google.maps.LatLng(a.lat(),a.lng());if(!1==site.nowThen.mapSharedImage)geocoder=new google.maps.Geocoder,geocoder.geocode({latLng:a},function(a,b){b==google.maps.GeocoderStatus.OK?a[0]&&(a[0].formatted_address=a[0].formatted_address.replace(/ /g,"+"),$("#urlqs").val("type=address&address="+a[0].formatted_address+"&withoutMedia=false&withoutLoc=false&onlyWithoutLoc=false&updateDays=0&sortOrderM=DISTANCE&sortOrderP=DISTANCE&keywords="),
$("#oldImages").submit()):alert("Geocoder failed due to: "+b)});else{var a=window.location.search,c=a.indexOf("id=")+3;site.nowThen.phId=a.substring(c,a.length);$("#assetId").val(site.nowThen.phId);$("#oldImage").submit()}},getUserLocation:function(){var a=new google.maps.InfoWindow;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(c){var d=new google.maps.LatLng(c.coords.latitude,c.coords.longitude);geocoder=new google.maps.Geocoder;geocoder.geocode({latLng:d},function(b,c){c==
google.maps.GeocoderStatus.OK?b[0]&&(site.nowThen.map.setZoom(15),site.nowThen.map.setCenter(d),marker=new google.maps.Marker({position:d,map:site.nowThen.map,icon:"../images/star.png"}),a.setContent("Your current location."),a.open(site.nowThen.map,marker),b[0].formatted_address=b[0].formatted_address.replace(/ /g,"+"),$("#urlqs").val("type=address&address="+b[0].formatted_address+"&withoutMedia=false&withoutLoc=false&onlyWithoutLoc=false&updateDays=0&sortOrderM=DISTANCE&sortOrderP=DISTANCE&keywords="),
$("#oldImages").submit()):alert("Geocoder failed due to: "+c)})}):alert("I'm sorry, but geolocation services are not supported by your browser.")},clearInfoWindows:function(){if(site.nowThen.infoWindowsArray)for(i in site.nowThen.infoWindowsArray)site.nowThen.infoWindowsArray[i].close()},clearMarkers:function(){if(site.nowThen.markersArray)for(i in site.nowThen.markersArray)site.nowThen.markersArray[i].setMap(null)},setInfoWindows:function(a,c,d,b,e,f,h,g,j){if(""==f||null==f)f="Unknown";var k="<div class='info'><div class='text'><strong>"+
b+"</strong><br/><small><strong>Location:</strong> "+e+"</small><br/><small><strong>Date taken: </strong>"+f+"</small><br/><small>To purchase a print visit <a href='"+("http://www.phillyhistory.org/PhotoArchive/Detail.aspx?assetId="+j)+"' target='_blank'>PhillyHistory.org</a></small></div><div class='shareLink'><label>Share a link to this image:</label> <input id='imgUrl' /></div> <a href='javascript:void(0)' class='close'>X</a></div><img src='http://phillyhistory.org/PhotoArchive/MediaStream.ashx?mediaId="+
imageId+"' class='img' />";google.maps.event.addListener(a,"click",function(){site.nowThen.clearInfoWindows();$("#large-image").html(k);$("#large-image").show("fast");$("#large-image .img").click(function(){$("#large-image").hide("fast");site.nowThen.mapSharedImage=!1});$("#large-image .close").click(function(){$("#large-image").hide("fast");site.nowThen.mapSharedImage=!1});site.nowThen.setShareLink(h,g,j)})},setShareLink:function(a,c,d){var b="http://skookul.com/now-and-then/index.php?ll="+a+","+
c+"&id="+d;$("#imgUrl").val(b);$("#imgUrl").click(function(){window.prompt("To copy the link, press Ctrl+C, then Enter.",b)})}};var panoramioLayer=new google.maps.panoramio.PanoramioLayer;
$(document).ready(function(){-1<window.location.href.indexOf("ll=")?(site.nowThen.mapSharedImage=!0,site.nowThen.loadMapSharedImage()):site.nowThen.loadMap();site.nowThen.setKml();site.nowThen.resetMarkers();google.maps.event.addListener(site.nowThen.map,"dragend",function(){site.nowThen.resetMarkers();site.nowThen.mapSharedImage=false});panoramioLayer.setMap(site.nowThen.map);$(document).keyup(function(a){if(a.keyCode==27){$("#large-image").hide("fast");site.nowThen.mapSharedImage=false}});$("#loader").append(site.nowThen.strLoading);
$("#loader").show();$("#icon-loading-data").show()});